## Сети ЭВМ и телекоммуникации ##
С.А. Климов

4/2/2015

## Клиент протокола POP-3 ##

#Задание.#
Разработать приложение для операционных систем семейства Windows, обеспечивающее функции клиента протокола POP-3.

#Основные возможности.#
Приложение должно реализовывать следующие функции:

1. Подключение к указанному серверу по IP-адресу или доменному
имени
2. Получение состояния ящика (количество новых писем, их суммарная
длина)
3. Получение списка заголовков всех новых писем сервера без предва-
рительной загрузки
4. Загрузка всех новых или конкретных выбранных писем
5. Пометка конкретных писем для последующего удаления
6. Удаление помеченных писем
7. Выход из приложения без удаления помеченных писем
8. Подробное протоколирование соединения сервера с клиентом

#Поддерживаемые команды.#
Разработанное приложение должно реализовывать следующие команды протокола POP-3:

- USER – передача серверу идентификационной информации пользователя
- PASS – передача серверу пароля пользователя
- STAT – получение состояния почтового ящика
- LIST – получение списка сообщения почтового ящика
- RETR – получение сообщения
- DELE – пометка сообщения на удаление
- TOP – получение первых нескольких строк сообщения
- UIDL – получение уникального идентификатора сообщения
- RSET – сброс всех пометок на удаление сообщений
- QUIT – удаление всех помеченных сообщений и завершение сеанса

#Настройки приложения.#
Разработанное приложение должно предоставлять пользователю настройку следующих параметров:

1. IP-адрес или доменное имя почтового сервера
2. Номер порта сервера (по умолчанию - 110)
3. Имя пользователя
4. Пароль пользователя

#Введение.

POP3 - стандартный интернет-протокол прикладного уровня, используемый клиентами электронной почты для получения почты с удаленного сервера по TCP/IP-соединению.

###Базовые операции.

Первоначально, сервер прослушивает TCP соединение на порту 110. Когда клиент желает воспользоваться сервисом POP3, он должен установить соединение с сервером. После установки соединения сервер посылает клиенту приветствие. Клиент и POP3 сервер обмениваются командами и ответами до тех пор, пока соединение не будет закрыто или прервано.

Команды POP3 состоят из нечувствительного к регистру ключевого слова, за которым может следовать один или несколько аргументов. Все команды заканчиваются парой CRLF. Ключевые слова и аргументы состоят из печатаемых ASCII символов. Ключевые слова и аргументы разделены одиночным пробелом. Ключевые слова состоят из 3-х или 4-х символа, каждый аргумент может быть длиной до 40 символов.

Ответы состоят из индикатора состояния и ключевого слова, иногда сопровождаемого дополнительной информацией. Все ответы заканчиваются парой CRLF. Ответ может быть длиной до 512 символов, включая завершающий CRLF. В настоящее время есть два индикатора состояния: положительный (+OK) и отрицательный (-ERR).

Определенные ответы могут быть многострочными. В этом случае, после первой строки ответа заканчивающейся CRLF, каждая дополнительно посланная строка заканчивается парой CRLF. После того как все строки ответа посланы, последняя строка будет заканчиваться завершающим октетом — символом «.» и парой CRLF. Таким образом, многострочный ответ заканчивается этими пятью октетами — «CRLF.CRLF».

В протоколе POP3 предусмотрено 3 состояния сеанса:

1.**Авторизация:**
После открытия клиентом TCP соединения, сервер посылает однострочное приветствие. Строка должна заканчиваться положительным ответом.

Пример:

	S:  +OK POP3 server ready
Теперь сессия находится в состоянии AUTHORIZATION. Клиент должен идентифицировать себя на сервере.

Для идентификации с помощью команд USER и PASS, клиент должен сначала послать команду USER. Если сервер ответил положительным индикатором состояния (+OK), то клиент должен послать команду PASS чтобы закончить авторизацию или послать команду QUIT для завершения сессии. Если сервер отправил отрицательный ответ (-ERR) на команду USER, то можно повторить авторизацию или закончить сессию командой QUIT.

2.**Транзакция:** 

После того как клиент успешно идентифицировал себя на сервере и сервер заблокировал и открыл соответствующий почтовый ящик, сессия переходит в состояние TRANSACTION. Теперь клиент может запрашивать информацию. После каждой команды сервер отправляет ответ. В конце клиент отправляет команду QUIT, и сессия переходит в состояние UPDATE.

3.**Обновление:** 

Когда клиент посылает команду QUIT в состоянии TRANSACTION, сервер переходит на стадию UPDATE.

Если сессия завершается по каким-либо другим причинам, без посылки команды QUIT, POP3 сессия не входит в стадию UPDATE и ни одно сообщение из почтового ящика не должно быть удаленно.

###Пример взаимодействия сервера и клиента в виде диаграмм последовательностей.

![](http://www.tcpipguide.com/free/diagrams/poptrans.png)

###Пример POP3 сессии
	S: <wait for connection on TCP port 110>
	C: <open connection>
	S:    +OK POP3 server ready <1896.697170952@dbc.mtview.ca.us>
	C:    APOP mrose c4c9334bac560ecc979e58001b3e22fb
	S:    +OK mrose's maildrop has 2 messages (320 octets)
	C: 	  STAT
	S:    +OK 2 320
	C:    LIST
	S:    +OK 2 messages (320 octets)
	S:    1 120
	S:    2 200
	S:    .
	C:    RETR 1
	S:    +OK 120 octets
	S:    <the POP3 server sends message 1>
	S:    .
	C:    DELE 1
	S:    +OK message 1 deleted
	C:    RETR 2
	S:    +OK 200 octets
	S:    <the POP3 server sends message 2>
	S: 	  .
	C:    DELE 2
	S: 	  +OK message 2 deleted
	C:    QUIT
	S:    +OK dewey POP3 server signing off (maildrop empty)
	C:  <close connection>
	S:  <wait for next connection>

Информация взята из RFC 1939 [https://www.ietf.org/rfc/rfc1939.txt](https://www.ietf.org/rfc/rfc1939.txt) (перевод на русский язык [http://www.vanderboot.ru/rfc/mail/1939.php](http://www.vanderboot.ru/rfc/mail/1939.php))

##Архитектура приложения

###Поддерживаемые команды.

- USER – передача серверу идентификационной информации пользователя
- PASS – передача серверу пароля пользователя
- STAT – получение состояния почтового ящика
- LIST – получение списка сообщения почтового ящика
- RETR – получение сообщения
- DELE – пометка сообщения на удаление
- TOP – получение первых нескольких строк сообщения
- UIDL – получение уникального идентификатора сообщения
- RSET – сброс всех пометок на удаление сообщений
- QUIT – удаление всех помеченных сообщений и завершение сеанса

В приложении реализован главный класс протокола - POP3 и класс POP3_SSL, являющийся наследником POP3, а также реализующий шифрование по средством SSL. Класс Client является непосредственно клиентом протокола POP3, предоставляющим консольный интерфейс.

Названия функции класса POP3, которые реализуют основную функциональность протокола совпадают с поддерживаемыми командами, их можно использовать при создании альтернативной оболочки клиента, например с графическим интерфейсом.

